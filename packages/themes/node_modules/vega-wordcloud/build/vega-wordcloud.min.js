!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-canvas"),require("vega-dataflow"),require("vega-util"),require("vega-scale"),require("vega-statistics")):"function"==typeof define&&define.amd?define(["exports","vega-canvas","vega-dataflow","vega-util","vega-scale","vega-statistics"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).vega=t.vega||{},t.vega.transforms={}),t.vega,t.vega,t.vega,t.vega,t.vega)}(this,(function(t,e,n,a,r,i){"use strict";var o=Math.PI/180,f=64,s=2048;function u(){var t,n,a,r,i,o,u,c=[256,256],m=h,p=[],v=Math.random,z={};function b(t,e,n){for(var a,r,i,o,f,s=e.x,u=e.y,l=Math.hypot(c[0],c[1]),x=m(c),h=v()<.5?1:-1,d=-h;(a=x(d+=h))&&(r=~~a[0],i=~~a[1],!(Math.min(Math.abs(r),Math.abs(i))>=l));)if(e.x=s+r,e.y=u+i,!(e.x+e.x0<0||e.y+e.y0<0||e.x+e.x1>c[0]||e.y+e.y1>c[1]||n&&y(e,t,c[0])||n&&(f=n,!((o=e).x+o.x1>f[0].x&&o.x+o.x0<f[1].x&&o.y+o.y1>f[0].y&&o.y+o.y0<f[1].y)))){for(var g,p=e.sprite,z=e.width>>5,b=c[0]>>5,M=e.x-(z<<4),w=127&M,S=32-w,T=e.y1-e.y0,W=(e.y+e.y0)*b+(M>>5),q=0;q<T;q++){g=0;for(var k=0;k<=z;k++)t[W+k]|=g<<S|(k<z?(g=p[q*z+k])>>>w:0);W+=b}return e.sprite=null,!0}return!1}return z.layout=function(){for(var y=function(t){t.width=t.height=1;var e=Math.sqrt(t.getContext("2d").getImageData(0,0,1,1).data.length>>2);t.width=(f<<5)/e,t.height=s/e;var n=t.getContext("2d");return n.fillStyle=n.strokeStyle="red",n.textAlign="center",{context:n,ratio:e}}(e.canvas()),h=function(t){var e=[],n=-1;for(;++n<t;)e[n]=0;return e}((c[0]>>5)*c[1]),d=null,g=p.length,m=-1,z=[],M=p.map((e=>({text:t(e),font:n(e),style:r(e),weight:i(e),rotate:o(e),size:~~(a(e)+1e-14),padding:u(e),xoff:0,yoff:0,x1:0,y1:0,x0:0,y0:0,hasText:!1,sprite:null,datum:e}))).sort(((t,e)=>e.size-t.size));++m<g;){var w=M[m];w.x=c[0]*(v()+.5)>>1,w.y=c[1]*(v()+.5)>>1,l(y,w,M,m),w.hasText&&b(h,w,d)&&(z.push(w),d?x(d,w):d=[{x:w.x+w.x0,y:w.y+w.y0},{x:w.x+w.x1,y:w.y+w.y1}],w.x-=c[0]>>1,w.y-=c[1]>>1)}return z},z.words=function(t){return arguments.length?(p=t,z):p},z.size=function(t){return arguments.length?(c=[+t[0],+t[1]],z):c},z.font=function(t){return arguments.length?(n=d(t),z):n},z.fontStyle=function(t){return arguments.length?(r=d(t),z):r},z.fontWeight=function(t){return arguments.length?(i=d(t),z):i},z.rotate=function(t){return arguments.length?(o=d(t),z):o},z.text=function(e){return arguments.length?(t=d(e),z):t},z.spiral=function(t){return arguments.length?(m=g[t]||t,z):m},z.fontSize=function(t){return arguments.length?(a=d(t),z):a},z.padding=function(t){return arguments.length?(u=d(t),z):u},z.random=function(t){return arguments.length?(v=t,z):v},z}function l(t,e,n,a){if(!e.sprite){var r=t.context,i=t.ratio;r.clearRect(0,0,(f<<5)/i,s/i);var u,l,y,x,h,d=0,g=0,c=0,m=n.length;for(--a;++a<m;){if(e=n[a],r.save(),r.font=e.style+" "+e.weight+" "+~~((e.size+1)/i)+"px "+e.font,u=r.measureText(e.text+"m").width*i,y=e.size<<1,e.rotate){var p=Math.sin(e.rotate*o),v=Math.cos(e.rotate*o),z=u*v,b=u*p,M=y*v,w=y*p;u=Math.max(Math.abs(z+w),Math.abs(z-w))+31>>5<<5,y=~~Math.max(Math.abs(b+M),Math.abs(b-M))}else u=u+31>>5<<5;if(y>c&&(c=y),d+u>=f<<5&&(d=0,g+=c,c=0),g+y>=s)break;r.translate((d+(u>>1))/i,(g+(y>>1))/i),e.rotate&&r.rotate(e.rotate*o),r.fillText(e.text,0,0),e.padding&&(r.lineWidth=2*e.padding,r.strokeText(e.text,0,0)),r.restore(),e.width=u,e.height=y,e.xoff=d,e.yoff=g,e.x1=u>>1,e.y1=y>>1,e.x0=-e.x1,e.y0=-e.y1,e.hasText=!0,d+=u}for(var S=r.getImageData(0,0,(f<<5)/i,s/i).data,T=[];--a>=0;)if((e=n[a]).hasText){for(l=(u=e.width)>>5,y=e.y1-e.y0,x=0;x<y*l;x++)T[x]=0;if(null==(d=e.xoff))return;g=e.yoff;var W=0,q=-1;for(h=0;h<y;h++){for(x=0;x<u;x++){var k=l*h+(x>>5),D=S[(g+h)*(f<<5)+(d+x)<<2]?1<<31-x%32:0;T[k]|=D,W|=D}W?q=h:(e.y0++,y--,h--,g++)}e.y1=e.y0+q,e.sprite=T.slice(0,(e.y1-e.y0)*l)}}}function y(t,e,n){n>>=5;for(var a,r=t.sprite,i=t.width>>5,o=t.x-(i<<4),f=127&o,s=32-f,u=t.y1-t.y0,l=(t.y+t.y0)*n+(o>>5),y=0;y<u;y++){a=0;for(var x=0;x<=i;x++)if((a<<s|(x<i?(a=r[y*i+x])>>>f:0))&e[l+x])return!0;l+=n}return!1}function x(t,e){var n=t[0],a=t[1];e.x+e.x0<n.x&&(n.x=e.x+e.x0),e.y+e.y0<n.y&&(n.y=e.y+e.y0),e.x+e.x1>a.x&&(a.x=e.x+e.x1),e.y+e.y1>a.y&&(a.y=e.y+e.y1)}function h(t){var e=t[0]/t[1];return function(t){return[e*(t*=.1)*Math.cos(t),t*Math.sin(t)]}}function d(t){return"function"==typeof t?t:function(){return t}}var g={archimedean:h,rectangular:function(t){var e=4*t[0]/t[1],n=0,a=0;return function(t){var r=t<0?-1:1;switch(Math.sqrt(1+4*r*t)-r&3){case 0:n+=e;break;case 1:a+=4;break;case 2:n-=e;break;default:a-=4}return[n,a]}}};const c=["x","y","font","fontSize","fontStyle","fontWeight","angle"],m=["text","font","rotate","fontSize","fontStyle","fontWeight"];function p(t){n.Transform.call(this,u(),t)}p.Definition={type:"Wordcloud",metadata:{modifies:!0},params:[{name:"size",type:"number",array:!0,length:2},{name:"font",type:"string",expr:!0,default:"sans-serif"},{name:"fontStyle",type:"string",expr:!0,default:"normal"},{name:"fontWeight",type:"string",expr:!0,default:"normal"},{name:"fontSize",type:"number",expr:!0,default:14},{name:"fontSizeRange",type:"number",array:"nullable",default:[10,50]},{name:"rotate",type:"number",expr:!0,default:0},{name:"text",type:"field"},{name:"spiral",type:"string",values:["archimedean","rectangular"]},{name:"padding",type:"number",expr:!0},{name:"as",type:"string",array:!0,length:7,default:c}]},a.inherits(p,n.Transform,{transform(t,e){!t.size||t.size[0]&&t.size[1]||a.error("Wordcloud size dimensions must be non-zero.");const n=t.modified();if(!(n||e.changed(e.ADD_REM)||m.some((function(n){const r=t[n];return a.isFunction(r)&&e.modified(r.fields)}))))return;const o=e.materialize(e.SOURCE).source,f=this.value,s=t.as||c;let u,l=t.fontSize||14;if(a.isFunction(l)?u=t.fontSizeRange:l=a.constant(l),u){const t=l,e=r.scale("sqrt")().domain(a.extent(o,t)).range(u);l=n=>e(t(n))}o.forEach((t=>{t[s[0]]=NaN,t[s[1]]=NaN,t[s[3]]=0}));const y=f.words(o).text(t.text).size(t.size||[500,500]).padding(t.padding||1).spiral(t.spiral||"archimedean").rotate(t.rotate||0).font(t.font||"sans-serif").fontStyle(t.fontStyle||"normal").fontWeight(t.fontWeight||"normal").fontSize(l).random(i.random).layout(),x=f.size(),h=x[0]>>1,d=x[1]>>1,g=y.length;for(let t,e,n=0;n<g;++n)t=y[n],e=t.datum,e[s[0]]=t.x+h,e[s[1]]=t.y+d,e[s[2]]=t.font,e[s[3]]=t.size,e[s[4]]=t.style,e[s[5]]=t.weight,e[s[6]]=t.rotate;return e.reflow(n).modifies(s)}}),t.wordcloud=p}));
//# sourceMappingURL=vega-wordcloud.min.js.map
