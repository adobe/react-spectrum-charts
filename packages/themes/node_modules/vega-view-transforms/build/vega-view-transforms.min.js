!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-dataflow"),require("vega-scenegraph"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-dataflow","vega-scenegraph","vega-util"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).vega=e.vega||{},e.vega.transforms={}),e.vega,e.vega,e.vega)}(this,(function(e,t,n,o){"use strict";const r="top",a="left",i="right",s="bottom",c="top-left",u="top-right",d="bottom-left",l="bottom-right",h="start",f="middle",m="end",y="x",b="y",x="group",g="axis",p="title",w="frame",k="scope",M="legend",v="row-header",T="row-footer",E="row-title",z="column-header",A="column-footer",_="column-title",B="padding",D="symbol",O="fit",q="fit-x",S="fit-y",j="pad",L="none",I="all",C="each",F="flush",G="column",H="row";function P(e){t.Transform.call(this,null,e)}function R(e,t,n){return t(e.bounds.clear(),e,n)}o.inherits(P,t.Transform,{transform(e,t){const o=t.dataflow,r=e.mark,a=r.marktype,i=n.Marks[a],s=i.bound;let c,u=r.bounds;if(i.nested)r.items.length&&o.dirty(r.items[0]),u=R(r,s),r.items.forEach((e=>{e.bounds.clear().union(u)}));else if(a===x||e.modified())switch(t.visit(t.MOD,(e=>o.dirty(e))),u.clear(),r.items.forEach((e=>u.union(R(e,s)))),r.role){case g:case M:case p:t.reflow()}else c=t.changed(t.REM),t.visit(t.ADD,(e=>{u.union(R(e,s))})),t.visit(t.MOD,(e=>{c=c||u.alignsWith(e.bounds),o.dirty(e),u.union(R(e,s))})),c&&(u.clear(),r.items.forEach((e=>u.union(e.bounds))));return n.boundClip(r),t.modifies("bounds")}});const U=":vega_identifier:";function V(e){t.Transform.call(this,0,e)}function W(e){t.Transform.call(this,null,e)}function J(e){t.Transform.call(this,null,e)}V.Definition={type:"Identifier",metadata:{modifies:!0},params:[{name:"as",type:"string",required:!0}]},o.inherits(V,t.Transform,{transform(e,t){const n=(r=t.dataflow)._signals[U]||(r._signals[U]=r.add(0)),o=e.as;var r;let a=n.value;return t.visit(t.ADD,(e=>e[o]=e[o]||++a)),n.set(this.value=a),t}}),o.inherits(W,t.Transform,{transform(e,t){let o=this.value;o||(o=t.dataflow.scenegraph().mark(e.markdef,function(e){const t=e.groups,n=e.parent;return t&&1===t.size?t.get(Object.keys(t.object)[0]):t&&n?t.lookup(n):null}(e),e.index),o.group.context=e.context,e.context.group||(e.context.group=o.group),o.source=this.source,o.clip=e.clip,o.interactive=e.interactive,this.value=o);const r=o.marktype===x?n.GroupItem:n.Item;return t.visit(t.ADD,(e=>r.call(e,o))),(e.modified("clip")||e.modified("interactive"))&&(o.clip=e.clip,o.interactive=!!e.interactive,o.zdirty=!0,t.reflow()),o.items=t.source,t}});const K={parity:e=>e.filter(((e,t)=>t%2?e.opacity=0:1)),greedy:(e,t)=>{let n;return e.filter(((e,o)=>o&&N(n.bounds,e.bounds,t)?e.opacity=0:(n=e,1)))}},N=(e,t,n)=>n>Math.max(t.x1-e.x2,e.x1-t.x2,t.y1-e.y2,e.y1-t.y2),Q=(e,t)=>{for(var n,o=1,r=e.length,a=e[0].bounds;o<r;a=n,++o)if(N(a,n=e[o].bounds,t))return!0},X=e=>{const t=e.bounds;return t.width()>1&&t.height()>1},Y=e=>(e.forEach((e=>e.opacity=1)),e),Z=(e,t)=>e.reflow(t.modified()).modifies("opacity");function $(e){t.Transform.call(this,null,e)}o.inherits(J,t.Transform,{transform(e,t){const a=K[e.method]||K.parity,i=e.separation||0;let c,u,d=t.materialize(t.SOURCE).source;if(!d||!d.length)return;if(!e.method)return e.modified("method")&&(Y(d),t=Z(t,e)),t;if(d=d.filter(X),!d.length)return;if(e.sort&&(d=d.slice().sort(e.sort)),c=Y(d),t=Z(t,e),c.length>=3&&Q(c,i)){do{c=a(c,i)}while(c.length>=3&&Q(c,i));c.length<3&&!o.peek(d).opacity&&(c.length>1&&(o.peek(c).opacity=0),o.peek(d).opacity=1)}var l,h,f,m,y;e.boundScale&&e.boundTolerance>=0&&(l=e.boundScale,h=e.boundOrient,f=+e.boundTolerance,m=l.range(),y=new n.Bounds,h===r||h===s?y.set(m[0],-1/0,m[1],1/0):y.set(-1/0,m[0],1/0,m[1]),y.expand(f||1),u=e=>y.encloses(e.bounds),d.forEach((e=>{u(e)||(e.opacity=0)})));const b=c[0].mark.bounds.clear();return d.forEach((e=>{e.opacity&&b.union(e.bounds)})),t}}),o.inherits($,t.Transform,{transform(e,t){const n=t.dataflow;if(t.visit(t.ALL,(e=>n.dirty(e))),t.fields&&t.fields.zindex){const e=t.source&&t.source[0];e&&(e.mark.zdirty=!0)}}});const ee=new n.Bounds;function te(e,t,n){return e[t]===n?0:(e[t]=n,1)}function ne(e){var t=e.items[0].orient;return t===a||t===i}function oe(e,t,o,c){var u,d,l=t.items[0],h=l.datum,f=null!=l.translate?l.translate:.5,m=l.orient,y=function(e){let t=+e.grid;return[e.ticks?t++:-1,e.labels?t++:-1,t+ +e.domain]}(h),b=l.range,x=l.offset,g=l.position,p=l.minExtent,w=l.maxExtent,k=h.title&&l.items[y[2]].items[0],M=l.titlePadding,v=l.bounds,T=k&&n.multiLineOffset(k),E=0,z=0;switch(ee.clear().union(v),v.clear(),(u=y[0])>-1&&v.union(l.items[u].bounds),(u=y[1])>-1&&v.union(l.items[u].bounds),m){case r:E=g||0,z=-x,d=Math.max(p,Math.min(w,-v.y1)),v.add(0,-d).add(b,0),k&&re(e,k,d,M,T,0,-1,v);break;case a:E=-x,z=g||0,d=Math.max(p,Math.min(w,-v.x1)),v.add(-d,0).add(0,b),k&&re(e,k,d,M,T,1,-1,v);break;case i:E=o+x,z=g||0,d=Math.max(p,Math.min(w,v.x2)),v.add(0,0).add(d,b),k&&re(e,k,d,M,T,1,1,v);break;case s:E=g||0,z=c+x,d=Math.max(p,Math.min(w,v.y2)),v.add(0,0).add(b,d),k&&re(e,k,d,M,0,0,1,v);break;default:E=l.x,z=l.y}return n.boundStroke(v.translate(E,z),l),te(l,"x",E+f)|te(l,"y",z+f)&&(l.bounds=ee,e.dirty(l),l.bounds=v,e.dirty(l)),l.mark.bounds.clear().union(v)}function re(e,t,n,o,r,a,i,s){const c=t.bounds;if(t.auto){const s=i*(n+r+o);let u=0,d=0;e.dirty(t),a?u=(t.x||0)-(t.x=s):d=(t.y||0)-(t.y=s),t.mark.bounds.clear().union(c.translate(-u,-d)),e.dirty(t)}s.union(c)}const ae=(e,t)=>Math.floor(Math.min(e,t)),ie=(e,t)=>Math.ceil(Math.max(e,t));function se(e){return(new n.Bounds).set(0,0,e.width||0,e.height||0)}function ce(e){const t=e.bounds.clone();return t.empty()?t.set(0,0,0,0):t.translate(-(e.x||0),-(e.y||0))}function ue(e,t,n){const r=o.isObject(e)?e[t]:e;return null!=r?r:void 0!==n?n:0}function de(e){return e<0?Math.ceil(-e):0}function le(e,t,n){var o,r,a,i,s,c,u,d,l,h,x,g=!n.nodirty,p=n.bounds===F?se:ce,w=ee.set(0,0,0,0),k=ue(n.align,G),M=ue(n.align,H),v=ue(n.padding,G),T=ue(n.padding,H),E=n.columns||t.length,z=E<=0?1:Math.ceil(t.length/E),A=t.length,_=Array(A),B=Array(E),D=0,O=Array(A),q=Array(z),S=0,j=Array(A),L=Array(A),P=Array(A);for(r=0;r<E;++r)B[r]=0;for(r=0;r<z;++r)q[r]=0;for(r=0;r<A;++r)c=t[r],s=P[r]=p(c),c.x=c.x||0,j[r]=0,c.y=c.y||0,L[r]=0,a=r%E,i=~~(r/E),D=Math.max(D,u=Math.ceil(s.x2)),S=Math.max(S,d=Math.ceil(s.y2)),B[a]=Math.max(B[a],u),q[i]=Math.max(q[i],d),_[r]=v+de(s.x1),O[r]=T+de(s.y1),g&&e.dirty(t[r]);for(r=0;r<A;++r)r%E==0&&(_[r]=0),r<E&&(O[r]=0);if(k===C)for(a=1;a<E;++a){for(x=0,r=a;r<A;r+=E)x<_[r]&&(x=_[r]);for(r=a;r<A;r+=E)_[r]=x+B[a-1]}else if(k===I){for(x=0,r=0;r<A;++r)r%E&&x<_[r]&&(x=_[r]);for(r=0;r<A;++r)r%E&&(_[r]=x+D)}else for(k=!1,a=1;a<E;++a)for(r=a;r<A;r+=E)_[r]+=B[a-1];if(M===C)for(i=1;i<z;++i){for(x=0,o=(r=i*E)+E;r<o;++r)x<O[r]&&(x=O[r]);for(r=i*E;r<o;++r)O[r]=x+q[i-1]}else if(M===I){for(x=0,r=E;r<A;++r)x<O[r]&&(x=O[r]);for(r=E;r<A;++r)O[r]=x+S}else for(M=!1,i=1;i<z;++i)for(o=(r=i*E)+E;r<o;++r)O[r]+=q[i-1];for(l=0,r=0;r<A;++r)l=_[r]+(r%E?l:0),j[r]+=l-t[r].x;for(a=0;a<E;++a)for(h=0,r=a;r<A;r+=E)h+=O[r],L[r]+=h-t[r].y;if(k&&ue(n.center,G)&&z>1)for(r=0;r<A;++r)(l=(s=k===I?D:B[r%E])-P[r].x2-t[r].x-j[r])>0&&(j[r]+=l/2);if(M&&ue(n.center,H)&&1!==E)for(r=0;r<A;++r)(h=(s=M===I?S:q[~~(r/E)])-P[r].y2-t[r].y-L[r])>0&&(L[r]+=h/2);for(r=0;r<A;++r)w.union(P[r].translate(j[r],L[r]));switch(l=ue(n.anchor,y),h=ue(n.anchor,b),ue(n.anchor,G)){case m:l-=w.width();break;case f:l-=w.width()/2}switch(ue(n.anchor,H)){case m:h-=w.height();break;case f:h-=w.height()/2}for(l=Math.round(l),h=Math.round(h),w.clear(),r=0;r<A;++r)t[r].mark.bounds.clear();for(r=0;r<A;++r)(c=t[r]).x+=j[r]+=l,c.y+=L[r]+=h,w.union(c.mark.bounds.union(c.bounds.translate(j[r],L[r]))),g&&e.dirty(c);return w}function he(e,t,n){var o,r,a,i,s,c,u,d=function(e){var t,n,o=e.items,r=o.length,a=0;const i={marks:[],rowheaders:[],rowfooters:[],colheaders:[],colfooters:[],rowtitle:null,coltitle:null};for(;a<r;++a)if(n=(t=o[a]).items,t.marktype===x)switch(t.role){case g:case M:case p:break;case v:i.rowheaders.push(...n);break;case T:i.rowfooters.push(...n);break;case z:i.colheaders.push(...n);break;case A:i.colfooters.push(...n);break;case E:i.rowtitle=n[0];break;case _:i.coltitle=n[0];break;default:i.marks.push(...n)}return i}(t),l=d.marks,h=n.bounds===F?fe:me,f=n.offset,y=n.columns||l.length,b=y<=0?1:Math.ceil(l.length/y),w=b*y;const k=le(e,l,n);k.empty()&&k.set(0,0,0,0),d.rowheaders&&(c=ue(n.headerBand,H,null),o=ye(e,d.rowheaders,l,y,b,-ue(f,"rowHeader"),ae,0,h,"x1",0,y,1,c)),d.colheaders&&(c=ue(n.headerBand,G,null),r=ye(e,d.colheaders,l,y,y,-ue(f,"columnHeader"),ae,1,h,"y1",0,1,y,c)),d.rowfooters&&(c=ue(n.footerBand,H,null),a=ye(e,d.rowfooters,l,y,b,ue(f,"rowFooter"),ie,0,h,"x2",y-1,y,1,c)),d.colfooters&&(c=ue(n.footerBand,G,null),i=ye(e,d.colfooters,l,y,y,ue(f,"columnFooter"),ie,1,h,"y2",w-y,1,y,c)),d.rowtitle&&(s=ue(n.titleAnchor,H),u=ue(f,"rowTitle"),u=s===m?a+u:o-u,c=ue(n.titleBand,H,.5),be(e,d.rowtitle,u,0,k,c)),d.coltitle&&(s=ue(n.titleAnchor,G),u=ue(f,"columnTitle"),u=s===m?i+u:r-u,c=ue(n.titleBand,G,.5),be(e,d.coltitle,u,1,k,c))}function fe(e,t){return"x1"===t?e.x||0:"y1"===t?e.y||0:"x2"===t?(e.x||0)+(e.width||0):"y2"===t?(e.y||0)+(e.height||0):void 0}function me(e,t){return e.bounds[t]}function ye(e,t,n,o,r,a,i,s,c,u,d,l,h,f){var m,y,b,x,g,p,w,k,M,v=n.length,T=0,E=0;if(!v)return T;for(m=d;m<v;m+=l)n[m]&&(T=i(T,c(n[m],u)));if(!t.length)return T;for(t.length>r&&(e.warn("Grid headers exceed limit: "+r),t=t.slice(0,r)),T+=a,y=0,x=t.length;y<x;++y)e.dirty(t[y]),t[y].mark.bounds.clear();for(m=d,y=0,x=t.length;y<x;++y,m+=l){for(g=(p=t[y]).mark.bounds,b=m;b>=0&&null==(w=n[b]);b-=h);s?(k=null==f?w.x:Math.round(w.bounds.x1+f*w.bounds.width()),M=T):(k=T,M=null==f?w.y:Math.round(w.bounds.y1+f*w.bounds.height())),g.union(p.bounds.translate(k-(p.x||0),M-(p.y||0))),p.x=k,p.y=M,e.dirty(p),E=i(E,g[u])}return E}function be(e,t,n,o,r,a){if(t){e.dirty(t);var i=n,s=n;o?i=Math.round(r.x1+a*r.width()):s=Math.round(r.y1+a*r.height()),t.bounds.translate(i-(t.x||0),s-(t.y||0)),t.mark.bounds.clear().union(t.bounds),t.x=i,t.y=s,e.dirty(t)}}function xe(e,t,n,o,y,b,x){const g=function(e,t){const n=e[t]||{};return(t,o)=>null!=n[t]?n[t]:null!=e[t]?e[t]:o}(n,t),p=function(e,t){let n=-1/0;return e.forEach((e=>{null!=e.offset&&(n=Math.max(n,e.offset))})),n>-1/0?n:t}(e,g("offset",0)),w=g("anchor",h),k=w===m?1:w===f?.5:0,M={align:C,bounds:g("bounds",F),columns:"vertical"===g("direction")?1:e.length,padding:g("margin",8),center:g("center"),nodirty:!0};switch(t){case a:M.anchor={x:Math.floor(o.x1)-p,column:m,y:k*(x||o.height()+2*o.y1),row:w};break;case i:M.anchor={x:Math.ceil(o.x2)+p,y:k*(x||o.height()+2*o.y1),row:w};break;case r:M.anchor={y:Math.floor(y.y1)-p,row:m,x:k*(b||y.width()+2*y.x1),column:w};break;case s:M.anchor={y:Math.ceil(y.y2)+p,x:k*(b||y.width()+2*y.x1),column:w};break;case c:M.anchor={x:p,y:p};break;case u:M.anchor={x:b-p,y:p,column:m};break;case d:M.anchor={x:p,y:x-p,row:m};break;case l:M.anchor={x:b-p,y:x-p,column:m,row:m}}return M}function ge(e,t){var o,r,c=t.items[0],u=c.datum,d=c.orient,l=c.bounds,h=c.x,f=c.y;return c._bounds?c._bounds.clear().union(l):c._bounds=l.clone(),l.clear(),function(e,t,n){var o=t.padding,r=o-n.x,c=o-n.y;if(t.datum.title){var u=t.items[1].items[0],d=u.anchor,l=t.titlePadding||0,h=o-u.x,f=o-u.y;switch(u.orient){case a:r+=Math.ceil(u.bounds.width())+l;break;case i:case s:break;default:c+=u.bounds.height()+l}switch((r||c)&&we(e,n,r,c),u.orient){case a:f+=pe(t,n,u,d,1,1);break;case i:h+=pe(t,n,u,m,0,0)+l,f+=pe(t,n,u,d,1,1);break;case s:h+=pe(t,n,u,d,0,0),f+=pe(t,n,u,m,-1,0,1)+l;break;default:h+=pe(t,n,u,d,0,0)}(h||f)&&we(e,u,h,f),(h=Math.round(u.bounds.x1-o))<0&&(we(e,n,-h,0),we(e,u,-h,0))}else(r||c)&&we(e,n,r,c)}(e,c,c.items[0].items[0]),l=function(e,t){return e.items.forEach((e=>t.union(e.bounds))),t.x1=e.padding,t.y1=e.padding,t}(c,l),o=2*c.padding,r=2*c.padding,l.empty()||(o=Math.ceil(l.width()+o),r=Math.ceil(l.height()+r)),u.type===D&&function(e){const t=e.reduce(((e,t)=>(e[t.column]=Math.max(t.bounds.x2-t.x,e[t.column]||0),e)),{});e.forEach((e=>{e.width=t[e.column],e.height=e.bounds.y2-e.y}))}(c.items[0].items[0].items[0].items),d!==L&&(c.x=h=0,c.y=f=0),c.width=o,c.height=r,n.boundStroke(l.set(h,f,h+o,f+r),c),c.mark.bounds.clear().union(l),c}function pe(e,t,o,r,a,i,s){const c="symbol"!==e.datum.type,u=o.datum.vgrad,d=(!c||!i&&u||s?t:t.items[0]).bounds[a?"y2":"x2"]-e.padding,l=u&&i?d:0,f=u&&i?0:d,y=a<=0?0:n.multiLineOffset(o);return Math.round(r===h?l:r===m?f-y:.5*(d-y))}function we(e,t,n,o){t.x+=n,t.y+=o,t.bounds.translate(n,o),t.mark.bounds.translate(n,o),e.dirty(t)}function ke(e){t.Transform.call(this,null,e)}o.inherits(ke,t.Transform,{transform(e,t){const o=t.dataflow;return e.mark.items.forEach((t=>{e.layout&&he(o,t,e.layout),function(e,t,o){var c,u,d,l,f,y=t.items,b=Math.max(0,t.width||0),D=Math.max(0,t.height||0),I=(new n.Bounds).set(0,0,b,D),C=I.clone(),F=I.clone(),G=[];for(l=0,f=y.length;l<f;++l)switch((u=y[l]).role){case g:(ne(u)?C:F).union(oe(e,u,b,D));break;case p:c=u;break;case M:G.push(ge(e,u));break;case w:case k:case v:case T:case E:case z:case A:case _:C.union(u.bounds),F.union(u.bounds);break;default:I.union(u.bounds)}if(G.length){const t={};G.forEach((e=>{(d=e.orient||i)!==L&&(t[d]||(t[d]=[])).push(e)}));for(const n in t){const r=t[n];le(e,r,xe(r,n,o.legends,C,F,b,D))}G.forEach((t=>{const n=t.bounds;if(n.equals(t._bounds)||(t.bounds=t._bounds,e.dirty(t),t.bounds=n,e.dirty(t)),!o.autosize||o.autosize.type!==O&&o.autosize.type!==q&&o.autosize.type!==S)I.union(n);else switch(t.orient){case a:case i:I.add(n.x1,0).add(n.x2,0);break;case r:case s:I.add(0,n.y1).add(0,n.y2)}}))}I.union(C).union(F),c&&I.union(function(e,t,n,o,c){var u,d=t.items[0],l=d.frame,f=d.orient,y=d.anchor,b=d.offset,g=d.padding,p=d.items[0].items[0],w=d.items[1]&&d.items[1].items[0],k=f===a||f===i?o:n,M=0,v=0,T=0,E=0,z=0;if(l!==x?f===a?(M=c.y2,k=c.y1):f===i?(M=c.y1,k=c.y2):(M=c.x1,k=c.x2):f===a&&(M=o,k=0),u=y===h?M:y===m?k:(M+k)/2,w&&w.text){switch(f){case r:case s:z=p.bounds.height()+g;break;case a:E=p.bounds.width()+g;break;case i:E=-p.bounds.width()-g}ee.clear().union(w.bounds),ee.translate(E-(w.x||0),z-(w.y||0)),te(w,"x",E)|te(w,"y",z)&&(e.dirty(w),w.bounds.clear().union(ee),w.mark.bounds.clear().union(ee),e.dirty(w)),ee.clear().union(w.bounds)}else ee.clear();switch(ee.union(p.bounds),f){case r:v=u,T=c.y1-ee.height()-b;break;case a:v=c.x1-ee.width()-b,T=u;break;case i:v=c.x2+ee.width()+b,T=u;break;case s:v=u,T=c.y2+b;break;default:v=d.x,T=d.y}return te(d,"x",v)|te(d,"y",T)&&(ee.translate(v,T),e.dirty(d),d.bounds.clear().union(ee),t.bounds.clear().union(ee),e.dirty(d)),d.bounds}(e,c,b,D,I));t.clip&&I.set(0,0,t.width||0,t.height||0);!function(e,t,n,o){const r=o.autosize||{},a=r.type;if(e._autosize<1||!a)return;let i=e._width,s=e._height,c=Math.max(0,t.width||0),u=Math.max(0,Math.ceil(-n.x1)),d=Math.max(0,t.height||0),l=Math.max(0,Math.ceil(-n.y1));const h=Math.max(0,Math.ceil(n.x2-c)),f=Math.max(0,Math.ceil(n.y2-d));if(r.contains===B){const t=e.padding();i-=t.left+t.right,s-=t.top+t.bottom}a===L?(u=0,l=0,c=i,d=s):a===O?(c=Math.max(0,i-u-h),d=Math.max(0,s-l-f)):a===q?(c=Math.max(0,i-u-h),s=d+l+f):a===S?(i=c+u+h,d=Math.max(0,s-l-f)):a===j&&(i=c+u+h,s=d+l+f);e._resizeView(i,s,c,d,[u,l],r.resize)}(e,t,I,o)}(o,t,e)})),(c=e.mark.group)&&"legend-entry"!==c.mark.role?t.reflow():t;var c}}),e.bound=P,e.identifier=V,e.mark=W,e.overlap=J,e.render=$,e.viewlayout=ke}));
//# sourceMappingURL=vega-view-transforms.min.js.map
