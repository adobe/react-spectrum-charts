!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("vega-scenegraph"),require("vega-canvas"),require("vega-dataflow"),require("vega-util")):"function"==typeof define&&define.amd?define(["exports","vega-scenegraph","vega-canvas","vega-dataflow","vega-util"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).vega=t.vega||{},t.vega.transforms={}),t.vega,t.vega,t.vega,t.vega)}(this,(function(t,e,n,a,r){"use strict";const i=4278190080;function o(t,e,n){return new Uint32Array(t.getImageData(0,0,e,n).data.buffer)}function s(t,n,a){if(!n.length)return;const r=n[0].mark.marktype;"group"===r?n.forEach((e=>{e.items.forEach((e=>s(t,e.items,a)))})):e.Marks[r].draw(t,{items:a?n.map(u):n})}function u(t){const e=a.rederive(t,{});return e.stroke&&0!==e.strokeOpacity||e.fill&&0!==e.fillOpacity?{...e,strokeOpacity:1,stroke:"#000",fillOpacity:0}:e}const f=5,l=31,d=32,c=new Uint32Array(d+1),m=new Uint32Array(d+1);m[0]=0,c[0]=~m[0];for(let t=1;t<=d;++t)m[t]=m[t-1]<<1|1,c[t]=~m[t];function g(t,e,n){const a=Math.max(1,Math.sqrt(t*e/1e6)),r=~~((t+2*n+a)/a),i=~~((e+2*n+a)/a),o=t=>~~((t+n)/a);return o.invert=t=>t*a-n,o.bitmap=()=>function(t,e){const n=new Uint32Array(~~((t*e+d)/d));function a(t,e){n[t]|=e}function r(t,e){n[t]&=e}return{array:n,get:(e,a)=>{const r=a*t+e;return n[r>>>f]&1<<(r&l)},set:(e,n)=>{const r=n*t+e;a(r>>>f,1<<(r&l))},clear:(e,n)=>{const a=n*t+e;r(a>>>f,~(1<<(a&l)))},getRange:(e,a,r,i)=>{let o,s,u,d,g=i;for(;g>=a;--g)if(o=g*t+e,s=g*t+r,u=o>>>f,d=s>>>f,u===d){if(n[u]&c[o&l]&m[1+(s&l)])return!0}else{if(n[u]&c[o&l])return!0;if(n[d]&m[1+(s&l)])return!0;for(let t=u+1;t<d;++t)if(n[t])return!0}return!1},setRange:(e,n,r,i)=>{let o,s,u,d,g;for(;n<=i;++n)if(o=n*t+e,s=n*t+r,u=o>>>f,d=s>>>f,u===d)a(u,c[o&l]&m[1+(s&l)]);else for(a(u,c[o&l]),a(d,m[1+(s&l)]),g=u+1;g<d;++g)a(g,4294967295)},clearRange:(e,n,a,i)=>{let o,s,u,d,g;for(;n<=i;++n)if(o=n*t+e,s=n*t+a,u=o>>>f,d=s>>>f,u===d)r(u,m[o&l]|c[1+(s&l)]);else for(r(u,m[o&l]),r(d,c[1+(s&l)]),g=u+1;g<d;++g)r(g,0)},outOfBounds:(n,a,r,i)=>n<0||a<0||i>=e||r>=t}}(r,i),o.ratio=a,o.padding=n,o.width=t,o.height=e,o}function h(t,e,n,a,r,i){let o=n/2;return t-o<0||t+o>r||e-(o=a/2)<0||e+o>i}function y(t,e,n,a,r,i,o,s){const u=r*i/(2*a),f=t(e-u),l=t(e+u),d=t(n-(i/=2)),c=t(n+i);return o.outOfBounds(f,d,l,c)||o.getRange(f,d,l,c)||s&&s.getRange(f,d,l,c)}const p=[-1,-1,1,1],x=[-1,1,-1,1];const v=["right","center","left"],b=["bottom","middle","top"];function w(t,e,n,a,r,i,o,s,u,f,l,d){return!(r.outOfBounds(t,n,e,a)||(d&&i||r).getRange(t,n,e,a))}const M={"top-left":0,top:1,"top-right":2,left:4,middle:5,right:6,"bottom-left":8,bottom:9,"bottom-right":10},k={naive:function(t,n,a,r){const i=t.width,o=t.height;return function(t){const n=t.datum.datum.items[r].items,a=n.length,s=t.datum.fontSize,u=e.textMetrics.width(t.datum,t.datum.text);let f,l,d,c,m,g,h,y=0;for(let e=0;e<a;++e)f=n[e].x,d=n[e].y,l=void 0===n[e].x2?f:n[e].x2,c=void 0===n[e].y2?d:n[e].y2,m=(f+l)/2,g=(d+c)/2,h=Math.abs(l-f+c-d),h>=y&&(y=h,t.x=m,t.y=g);return m=u/2,g=s/2,f=t.x-m,l=t.x+m,d=t.y-g,c=t.y+g,t.align="center",f<0&&l<=i?t.align="left":0<=f&&i<l&&(t.align="right"),t.baseline="middle",d<0&&c<=o?t.baseline="top":0<=d&&o<c&&(t.baseline="bottom"),!0}},"reduced-search":function(t,n,a,r){const i=t.width,o=t.height,s=n[0],u=n[1];function f(e,n,a,r,f){const l=t.invert(e),d=t.invert(n);let c,m=a,g=o;if(!h(l,d,r,f,i,o)&&!y(t,l,d,f,r,m,s,u)&&!y(t,l,d,f,r,f,s,null)){for(;g-m>=1;)c=(m+g)/2,y(t,l,d,f,r,c,s,u)?g=c:m=c;if(m>a)return[l,d,m,!0]}}return function(n){const u=n.datum.datum.items[r].items,l=u.length,d=n.datum.fontSize,c=e.textMetrics.width(n.datum,n.datum.text);let m,g,p,x,v,b,w,M,k,R,z,A,O,E,S,q,B,T=a?d:0,U=!1,C=!1,D=0;for(let e=0;e<l;++e){for(m=u[e].x,p=u[e].y,g=void 0===u[e].x2?m:u[e].x2,x=void 0===u[e].y2?p:u[e].y2,m>g&&(B=m,m=g,g=B),p>x&&(B=p,p=x,x=B),k=t(m),z=t(g),R=~~((k+z)/2),A=t(p),E=t(x),O=~~((A+E)/2),w=R;w>=k;--w)for(M=O;M>=A;--M)q=f(w,M,T,c,d),q&&([n.x,n.y,T,U]=q);for(w=R;w<=z;++w)for(M=O;M<=E;++M)q=f(w,M,T,c,d),q&&([n.x,n.y,T,U]=q);U||a||(S=Math.abs(g-m+x-p),v=(m+g)/2,b=(p+x)/2,S>=D&&!h(v,b,c,d,i,o)&&!y(t,v,b,d,c,d,s,null)&&(D=S,n.x=v,n.y=b,C=!0))}return!(!U&&!C)&&(v=c/2,b=d/2,s.setRange(t(n.x-v),t(n.y-b),t(n.x+v),t(n.y+b)),n.align="center",n.baseline="middle",!0)}},floodfill:function(t,n,a,r){const i=t.width,o=t.height,s=n[0],u=n[1],f=t.bitmap();return function(n){const l=n.datum.datum.items[r].items,d=l.length,c=n.datum.fontSize,m=e.textMetrics.width(n.datum,n.datum.text),g=[];let v,b,w,M,k,R,z,A,O,E,S,q,B=a?c:0,T=!1,U=!1,C=0;for(let e=0;e<d;++e){for(v=l[e].x,w=l[e].y,b=void 0===l[e].x2?v:l[e].x2,M=void 0===l[e].y2?w:l[e].y2,g.push([t((v+b)/2),t((w+M)/2)]);g.length;)if([z,A]=g.pop(),!(s.get(z,A)||u.get(z,A)||f.get(z,A))){f.set(z,A);for(let t=0;t<4;++t)k=z+p[t],R=A+x[t],f.outOfBounds(k,R,k,R)||g.push([k,R]);if(k=t.invert(z),R=t.invert(A),O=B,E=o,!h(k,R,m,c,i,o)&&!y(t,k,R,c,m,O,s,u)&&!y(t,k,R,c,m,c,s,null)){for(;E-O>=1;)S=(O+E)/2,y(t,k,R,c,m,S,s,u)?E=S:O=S;O>B&&(n.x=k,n.y=R,B=O,T=!0)}}T||a||(q=Math.abs(b-v+M-w),k=(v+b)/2,R=(w+M)/2,q>=C&&!h(k,R,m,c,i,o)&&!y(t,k,R,c,m,c,s,null)&&(C=q,n.x=k,n.y=R,U=!0))}return!(!T&&!U)&&(k=m/2,R=c/2,s.setRange(t(n.x-k),t(n.y-R),t(n.x+k),t(n.y+R)),n.align="center",n.baseline="middle",!0)}}};function R(t,a,r,u,f,l,d,c,m,h,y){if(!t.length)return t;const p=Math.max(u.length,f.length),x=function(t,e){const n=new Float64Array(e),a=t.length;for(let e=0;e<a;++e)n[e]=t[e]||0;for(let t=a;t<e;++t)n[t]=n[a-1];return n}(u,p),R=function(t,e){const n=new Int8Array(e),a=t.length;for(let e=0;e<a;++e)n[e]|=M[t[e]];for(let t=a;t<e;++t)n[t]=n[a-1];return n}(f,p),z=(B=t[0].datum)&&B.mark&&B.mark.marktype,A="group"===z&&t[0].datum.items[m].marktype,O="area"===A,E=function(t,e,n,a){const r=t=>[t.x,t.x,t.x,t.y,t.y,t.y];return t?"line"===t||"area"===t?t=>r(t.datum):"line"===e?t=>{const e=t.datum.items[a].items;return r(e.length?e["start"===n?0:e.length-1]:{x:NaN,y:NaN})}:t=>{const e=t.datum.bounds;return[e.x1,(e.x1+e.x2)/2,e.x2,e.y1,(e.y1+e.y2)/2,e.y2]}:r}(z,A,c,m),S=null===h||h===1/0,q=O&&"naive"===y;var B;let T=-1,U=-1;const C=t.map((t=>{const n=S?e.textMetrics.width(t,t.text):void 0;return T=Math.max(T,n),U=Math.max(U,t.fontSize),{datum:t,opacity:0,x:void 0,y:void 0,align:void 0,baseline:void 0,boundary:E(t),textWidth:n}}));h=null===h||h===1/0?Math.max(T,U)+Math.max(...u):h;const D=g(a[0],a[1],h);let I;if(!q){r&&C.sort(((t,e)=>r(t.datum,e.datum)));let e=!1;for(let t=0;t<R.length&&!e;++t)e=5===R[t]||x[t]<0;const a=(z&&d||O)&&t.map((t=>t.datum));I=l.length||a?function(t,e,a,r,u){const f=t.width,l=t.height,d=r||u,c=n.canvas(f,l).getContext("2d"),m=n.canvas(f,l).getContext("2d"),g=d&&n.canvas(f,l).getContext("2d");a.forEach((t=>s(c,t,!1))),s(m,e,!1),d&&s(g,e,!0);const h=o(c,f,l),y=o(m,f,l),p=d&&o(g,f,l),x=t.bitmap(),v=d&&t.bitmap();let b,w,M,k,R,z,A,O;for(w=0;w<l;++w)for(b=0;b<f;++b)R=w*f+b,z=h[R]&i,O=y[R]&i,A=d&&p[R]&i,(z||A||O)&&(M=t(b),k=t(w),u||!z&&!O||x.set(M,k),d&&(z||A)&&v.set(M,k));return[x,v]}(D,a||[],l,e,O):function(t,e){const n=t.bitmap();return(e||[]).forEach((e=>n.set(t(e.boundary[0]),t(e.boundary[3])))),[n,void 0]}(D,d&&C)}const N=O?k[y](D,I,d,m):function(t,n,a,r){const i=t.width,o=t.height,s=n[0],u=n[1],f=r.length;return function(n){const l=n.boundary,d=n.datum.fontSize;if(l[2]<0||l[5]<0||l[0]>i||l[3]>o)return!1;let c,m,g,h,y,p,x,M,k,R,z,A,O,E,S,q=n.textWidth??0;for(let i=0;i<f;++i){if(c=(3&a[i])-1,m=(a[i]>>>2&3)-1,g=0===c&&0===m||r[i]<0,h=c&&m?Math.SQRT1_2:1,y=r[i]<0?-1:1,p=l[1+c]+r[i]*c*h,z=l[4+m]+y*d*m/2+r[i]*m*h,M=z-d/2,k=z+d/2,A=t(p),E=t(M),S=t(k),!q){if(!w(A,A,E,S,s,u,0,0,0,0,0,g))continue;q=e.textMetrics.width(n.datum,n.datum.text)}if(R=p+y*q*c/2,p=R-q/2,x=R+q/2,A=t(p),O=t(x),w(A,O,E,S,s,u,0,0,0,0,0,g))return n.x=c?c*y<0?x:p:R,n.y=m?m*y<0?k:M:z,n.align=v[c*y+1],n.baseline=b[m*y+1],s.setRange(A,E,O,S),!0}return!1}}(D,I,R,x);return C.forEach((t=>t.opacity=+N(t))),C}const z=["x","y","opacity","align","baseline"],A=["top-left","left","bottom-left","top","bottom","top-right","right","bottom-right"];function O(t){a.Transform.call(this,null,t)}O.Definition={type:"Label",metadata:{modifies:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"sort",type:"compare"},{name:"anchor",type:"string",array:!0,default:A},{name:"offset",type:"number",array:!0,default:[1]},{name:"padding",type:"number",default:0,null:!0},{name:"lineAnchor",type:"string",values:["start","end"],default:"end"},{name:"markIndex",type:"number",default:0},{name:"avoidBaseMark",type:"boolean",default:!0},{name:"avoidMarks",type:"data",array:!0},{name:"method",type:"string",default:"naive"},{name:"as",type:"string",array:!0,length:z.length,default:z}]},r.inherits(O,a.Transform,{transform(t,e){const n=t.modified();if(!(n||e.changed(e.ADD_REM)||function(n){const a=t[n];return r.isFunction(a)&&e.modified(a.fields)}("sort")))return;t.size&&2===t.size.length||r.error("Size parameter should be specified as a [width, height] array.");const a=t.as||z;return R(e.materialize(e.SOURCE).source||[],t.size,t.sort,r.array(null==t.offset?1:t.offset),r.array(t.anchor||A),t.avoidMarks||[],!1!==t.avoidBaseMark,t.lineAnchor||"end",t.markIndex||0,void 0===t.padding?0:t.padding,t.method||"naive").forEach((t=>{const e=t.datum;e[a[0]]=t.x,e[a[1]]=t.y,e[a[2]]=t.opacity,e[a[3]]=t.align,e[a[4]]=t.baseline})),e.reflow(n).modifies(a)}}),t.label=O}));
//# sourceMappingURL=vega-label.min.js.map
